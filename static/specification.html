<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Web Monetization
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove"
    defer></script>
    <script class="remove">
      'use strict'
      // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
      var respecConfig = {
        edDraftURI: 'https://webmonetization.org/specification.html',
        github: {
          repoURL: 'wicg/webmonetization',
          branch: 'main',
        },
        editors: [
          {
            name: 'Adrian Hope-Bailie',
            email: 'adrian@coil.com',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          },
          {
            name: 'Ben Sharafian',
            email: 'ben@coil.com',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          },
          {
            name: 'Nick Dudfield',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          }
        ],
        shortName: 'web-monetization',
        specStatus: 'CG-DRAFT',
        group: 'wicg',
        xref: 'web-platform',
        localBiblio: {
          Interledger: {
            title: 'Interledger Protocol',
            href: 'https://interledger.org/rfcs/0027-interledger-protocol-4/'
          },
          SPSP: {
            title: 'Simple Payments Setup Protocol',
            href:
              'https://interledger.org/rfcs/0009-simple-payment-setup-protocol'
          },
          STREAM: {
            title: 'STREAM',
            href:
              'https://interledger.org/rfcs/0029-stream/'
          },
          Receipt: {
            title: 'STREAM Receipt',
            href:
              'https://interledger.org/rfcs/0039-stream-receipts/'
          },
        }
      }
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>
        Web Monetization is an API that allows websites to automatically
        receive micro-payments from users, facilitated by the browser and a
        user's Web Monetization provider.
      </p>
    </section>
    <section id="sotd">
      <div class="warning">
        <p>
          This specification is a work in progress within the community on the
          best shape it should take. Please see the <a href=
          "./docs/explainer">explainer</a> for more info.
        </p>
        <p>
          The specification reflects the desired end-state of the Web
          Monetization APIs as currently anticipated and agreed to between the
          contributors. The specification is being prepared here, in this
          format, to collect the input of the Web community and prepare the
          work to ultimately follow the W3C standards track should it have the
          necessary support to do so.
        </p>
        <p>
          For the most accurate reflection of the APIs that have been
          implemented by providers see the <a href="./docs/api">API
          documentation</a>.
        </p>
      </div>
    </section>
    <section id="terminology">
      <h2>
        Terminology
      </h2>
      <dl>
        <dt>
          <dfn data-lt="provider">Web Monetization provider</dfn>:
        </dt>
        <dd>
          The party making payments on behalf of the user. A Web Monetization
          provider uses the [[[SPSP]]] (<abbr title=
          "Simple Payment Setup Protocol">SPSP</abbr>) on top of the
          [[[Interledger]]] (<abbr title=
          "Interledger Protocol">ILP</abbr>)/[[[STREAM]]] to provide a
          high-level way to send money and data.
        </dd>
        <dt>
          <dfn>Web Monetization receiver</dfn>:
        </dt>
        <dd>
          The party receiving payments on behalf of the website.
        </dd>
        <dt>
          <dfn>Payment end-point</dfn>:
        </dt>
        <dd>
          A [=URL=] to a conforming HTTP <a data-cite="SPSP#specification">SPSP
          end-point</a>.
        </dd>
      </dl>
    </section>
    <section id="goals" class="informative">
      <h2>
        Goals
      </h2>
      <ul>
        <li>Suitable for static HTML documents, without requiring backend
        infrastructure.
        </li>
        <li>Doesn't require user interaction, but user retains control over
        which sites they monetize and how much they spend.
        </li>
        <li>Developers have a way to associate payments with their users, in
        order to provide a range of experiences.
        </li>
        <li>Pays continuously as the user consumes content.
        </li>
      </ul>
    </section>
    <section>
      <h2>
        Extensions to the `Navigator` interface
      </h2>
      <pre class="idl">
        partial interface Navigator {
          readonly attribute Monetization monetization;
        };
      </pre>
    </section>
    <section>
      <h2>
        Link type "monetization"
      </h2>
      <aside class="issue">
        This is a "monkey patch" for the HTML spec, which means this would
        eventually be moved to the HTML spec.
      </aside>
      <p>
        The monetization keyword indicates a [=payment end-point=] used to
        monetize the document.
      </p>
      <aside class="issue" data-number="192"></aside>
      <p>
        Every instance of {{Navigator}} has an <dfn data-dfn-for=
        "Navigator">[[\activeMonetizationElement]]</dfn> internal slot of type
        {{HTMLLinkElement}}, which represents the element in the document which
        controls the monetization. It is initialized as `null`.
      </p>
      <p>
        The <code data-x="rel-monetization">monetization</code> keyword may be
        used with <code>link</code> elements. This keyword creates an
        <span data-x="external resource link">external resource link</span>.
      </p>
      <p>
        Only the first <code>link</code> element in <span>tree order</span>
        whose <code data-x="attr-link-rel">rel</code> attribute contains the
        token <code data-x="rel-monetization">monetization</code> may be used.
      </p>
      <p>
        The <code data-x="rel-monetization">monetization</code> keyword
        indicates the [=payment end-point=] to associate with this browsing
        context.
      </p>
      <div>
        <p>
          There is no default type for resources given by the <code data-x=
          "rel-monetization">monetization</code> keyword.
        </p>
        <p>
          The appropriate times to <span data-x=
          "fetch and process the linked resource">fetch and process</span> this
          type of link is:
        </p>
        <ul>
          <li>
            <p>
              When {{Navigator}}'s {{Navigator/[[activeMonetizationElement]]}}
              is `null`.
            </p>
          </li>
          <li>
            <p>
              When the <span>external resource link</span> is created on a
              <code>link</code> element that is already <span>browsing-context
              connected</span>.
            </p>
          </li><!-- e.g. rel="" changed, href="" set... -->
          <li>
            <p>
              When the <span>external resource link</span>'s <code>link</code>
              element <span>becomes browsing-context connected</span>.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-href">href</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span> is changed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-disabled">disabled</code>
              attribute of the <code>link</code> element of an <span>external
              resource link</span> that is already <span>browsing-context
              connected</span> is set, changed, or removed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-crossorigin">crossorigin</code>
              attribute of the <code>link</code> element of an <span data-x=
              "external resource link">external resource link</span> that is
              already <span>browsing-context connected</span> is set, changed,
              or removed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-type">type</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span> is set or changed to a value that does not or no
              longer matches the <span data-x="Content-Type">Content-Type
              metadata</span> of the previous obtained external resource, if
              any.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-type">type</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span>, but was previously not obtained due to the
              <code data-x="attr-link-type">type</code> attribute specifying an
              unsupported type, is set, removed, or changed.
            </p>
          </li>
        </ul>
        <p>
          A user agent must not <span>delay the load event</span> for this link
          type.
        </p>
        <p>
          The <span>linked resource fetch setup steps</span> for this type of
          linked resource, given a <code>link</code> element <var>el</var> and
          <span data-x="concept-request">request</span> <var>request</var>,
          are:
        </p>
        <ol>
          <li>
            <p>
              If {{Navigator}}'s {{Navigator\[[activeMonetizationElement]]}} is
              not `null`, then return false.
            </p>
          </li>
          <li>
            <!-- detached element / non-fully active elements -->
            <p>
              If <var>el</var> <span>cannot navigate</span>, then return false.
            </p>
          </li>
          <li>
            <p>
              If <var>el</var>'s <span>node document</span> is not allowed to
              use the "monetization" feature, return false.
            </p>
          </li>
          <li>
            <p>
              If <var>el</var>'s is not the the first <code>link</code> element
              in <span>tree order</span> whose <code data-x=
              "attr-link-rel">rel</code> attribute contains the token
              <code data-x="rel-manifest">manifest</code>, return false.
            </p>
          </li>
          <li>
            <p>
              Set {{Navigator}}'s {{Navigator\[[activeMonetizationElement]]}}
              to element.
            </p>
          </li>
          <li>
            <p>
              Let <var>context</var> be <var>el</var>'s <span>node
              document</span>'s <span data-x="concept-document-bc">browsing
              context</span>.
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-initiator">initiator</span> to "".
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-destination">destination</span> to
              "<code data-x="">????</code>".
            </p>
            <aside class="issue">
              <p>
                We need to coordinate with the fetch spec here... I suspect we
                need a new request [=request/destination=] "monetization".
              </p>
            </aside>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-mode">mode</span> to "<code data-x=
              "">cors</code>".
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-credentials-mode">credentials mode</span> to the
              <span>CORS settings attribute credentials mode</span> for
              <var>el</var>'s <code data-x=
              "attr-link-crossorigin">crossorigin</code> content attribute.
            </p>
          </li>
          <li>
            <p>
              Return true.
            </p>
          </li>
        </ol>
        <p>
          To <span data-x="process the linked resource">process this type of
          linked resource</span> given a <code>link</code> element
          <var>el</var>, boolean <var>success</var>, and <span data-x=
          "concept-response">response</span> <var>response</var>:
        </p>
        <ol>
          <li>
            <p>
              If <var>response</var>'s <span data-x="Content-Type">Content-Type
              metadata</span> is not a <span>JSON MIME type</span>, then set
              <var>success</var> to false.
            </p>
            <aside class="issue">
              <p>
                We can be more strict about the media type here, but we need to
                formally register the media type with IANA
                (`application/spsp+json`). However, we can also be more
                lenient, and allow the media type to just be anything that ends
                with "+json".
              </p>
            </aside>
          </li>
          <li>
            <p>
              If <var>success</var> is true, then <span>initialize
              monetization</span> given <var>el</var> and <var>response</var>.
            </p>
          </li>
        </ol>
      </div>
      <p>
        If the {{Navigator}}'s {{Navigator\[[activeMonetizationElement]]}}
        <span>becomes browsing-context disconnected</span> run the following
        [=removing steps=]:
      </p>
      <ol>
        <li>Set {{Navigator}}'s {{Navigator\[[activeMonetizationElement]]}} to
        `null`.
        </li>
        <li>Stop monetization.
        </li>
        <li>Re-establish a new "monetization" link relationship, if one is
        available.
        </li>
      </ol>
    </section>
    <section>
      <h2>
        Monetization API
      </h2>
      <section data-dfn-for="Monetization">
        <h2>
          `Monetization` interface
        </h2>
        <pre class="idl">
          [Exposed=Window, SecureContext]
          interface Monetization : EventTarget {
            readonly attribute MonetizationState state;
            attribute EventHandler onprogress;
          };
        </pre>
        <section>
          <h2>
            <dfn>state</dfn> attribute
          </h2>
          <p>
            A {{Monetization/state}} attribute exposes the current state of Web
            Monetization as a {{MonetizationState}} enum value.
          </p>
        </section>
        <section>
          <h2>
            <dfn>onprogress</dfn> attribute
          </h2>
          <p>
            A {{Monetization/onprogress}} attribute is an [=event handler IDL
            attribute=] for an {{MonetizationEvent}} named "<a>progress</a>".
          </p>
        </section>
      </section>
      <section data-dfn-for="MonetizationState">
        <h2>
          <dfn>MonetizationState</dfn> enum
        </h2>
        <pre class="idl">
            enum MonetizationState {
              "pending",
              "started"
            };
          </pre>
        <dl>
          <dt>
            "<dfn>pending</dfn>"
          </dt>
          <dd>
            Indicates that monetization has not yet started.
          </dd>
          <dt>
            "<dfn>started</dfn>"
          </dt>
          <dd>
            Indicates that monetization has started (i.e. the user agent fired
            the `"start"` event).
          </dd>
        </dl>
      </section>
      <section id="events">
        <h2>
          Events
        </h2>
        <section class="informative">
          <h2>
            Summary
          </h2>
          <table class="def data">
            <tr>
              <th>
                Event name
              </th>
              <th>
                Interface
              </th>
              <th>
                Dispatched when…
              </th>
              <th>
                Target
              </th>
            </tr>
            <tr>
              <td>
                <code><dfn data-dfn-for="monetization" class=
                "event">progress</dfn></code>
              </td>
              <td>
                {{MonetizationEvent}}
              </td>
              <td>
                A payment is successfully made to the receiver.
              </td>
              <td>
                {{Navigator/monetization}}
              </td>
            </tr>
          </table>
        </section>
        <section data-dfn-for="MonetizationEvent">
          <h2>
            `MonetizationEvent` interface
          </h2>
          <pre class="idl">
            [SecureContext, Exposed=Window]
            interface MonetizationEvent : Event {
              constructor(DOMString type, MonetizationEventInit eventInitDict);
              readonly attribute USVString paymentPointer;
              readonly attribute DOMString requestId;
              readonly attribute DOMString amount;
              readonly attribute DOMString assetCode;
              readonly attribute DOMString assetScale;
              readonly attribute DOMString receipt;
            };
          </pre>
          <section>
            <h2>
              <dfn>paymentPointer</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/paymentPointer}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
          <section>
            <h2>
              <dfn>requestId</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/requestId}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
          <section>
            <h2>
              <dfn>amount</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/amount}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
          <section>
            <h2>
              <dfn>assetCode</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/assetCode}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
          <section>
            <h2>
              <dfn>assetScale</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/assetScale}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
          <section>
            <h2>
              <dfn>receipt</dfn> attribute
            </h2>
            <p>
              When getting, returns the value it was initialized with. See
              {{MonetizationEventInit/receipt}} member of
              {{MonetizationEventInit}} for more information.
            </p>
          </section>
        </section>
        <section data-dfn-for="MonetizationEventInit">
          <h3>
            <dfn>MonetizationEventInit</dfn> dictionary
          </h3>
          <p>
            Dispatched once the first ILP packet with a non-zero amount has
            been fulfilled by the page's SPSP receiver. MUST be dispatched at
            least once if payment occurs.
          </p>
          <pre class="idl">
              dictionary MonetizationEventInit : EventInit {
                required USVString paymentPointer;
                required DOMString requestId;
                required DOMString amount;
                required DOMString assetCode;
                required DOMString assetScale;
                required DOMString receipt;
              };
            </pre>
          <dl>
            <dt>
              <dfn>paymentPointer</dfn> member
            </dt>
            <dd>
              A string representing a [=payment end-point=].
            </dd>
            <dt>
              <dfn>requestId</dfn> member
            </dt>
            <dd>
              The Monetization ID (UUID V4) [[RFC4122]].
            </dd>
            <dt>
              <dfn>amount</dfn> member
            </dt>
            <dd>
              The destination amount <em>received</em> as specified in the ILP
              packet.
            </dd>
            <dt>
              <dfn>assetCode</dfn> member
            </dt>
            <dd>
              The three letter asset code describing the amount's units.
            </dd>
            <dt>
              <dfn>assetScale</dfn> member
            </dt>
            <dd>
              The scale of the amount. For example, USD would have an
              <code>assetScale</code> of <code>2</code> when denominated in
              cents.
            </dd>
            <dt>
              <dfn>receipt</dfn> member
            </dt>
            <dd>
              base64-encoded [[[Receipt]]] issued by the Web Monetization
              receiver to the Web Monetization provider as proof of the total
              amount received in the stream.
            </dd>
          </dl>
        </section>
      </section>
    </section>
    <section id="relation-to-other-technologies" class="informative">
      <h2>
        Relation to other technologies
      </h2>
      <p>
        Unlike [[[payment-Request]]] and the [[[Payment-Handler]]], Web
        Monetization is intended for continuous payments rather than discrete
        payments. Additionally, it is designed to <em>not</em> require any user
        interaction, serving as an alternative to traditional e-commerce
        checkout methods.
      </p>
    </section>
    <section id="conformance" class="appendix"></section>
  </body>
</html>
