<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Web Monetization
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove"
    defer></script>
    <script class="remove">
      'use strict'
      // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
      var respecConfig = {
        edDraftURI: 'https://webmonetization.org/specification.html',
        github: {
          repoURL: 'wicg/webmonetization',
          branch: 'main',
        },
        editors: [
          {
            name: 'Adrian Hope-Bailie',
            email: 'adrian@coil.com',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          },
          {
            name: 'Ben Sharafian',
            email: 'ben@coil.com',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          },
          {
            name: 'Nick Dudfield',
            company: 'Coil Technologies Inc.',
            companyURL: 'https://coil.com'
          }
        ],
        shortName: 'web-monetization',
        specStatus: 'CG-DRAFT',
        group: 'wicg',
        xref: 'web-platform',
        localBiblio: {
          Interledger: {
            title: 'Interledger Protocol',
            href: 'https://interledger.org/rfcs/0027-interledger-protocol-4/'
          },
          SPSP: {
            title: 'Simple Payments Setup Protocol',
            href:
              'https://interledger.org/rfcs/0009-simple-payment-setup-protocol'
          },
          STREAM: {
            title: 'STREAM',
            href:
              'https://interledger.org/rfcs/0029-stream/'
          },
          Receipt: {
            title: 'STREAM Receipt',
            href:
              'https://interledger.org/rfcs/0039-stream-receipts/'
          },
        }
      }
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>
        Web Monetization allows websites to automatically receive payments from
        users, facilitated by the user agent and a user's preferred
        monetization provider.
      </p>
    </section>
    <section id="sotd">
      <div class="warning">
        <p>
          This specification is a work in progress within the community on the
          best shape it should take. Please see the <a href=
          "./docs/explainer">explainer</a> for more info.
        </p>
        <p>
          The specification reflects the desired end-state of the Web
          Monetization APIs as currently anticipated and agreed to between the
          contributors. The specification is being prepared here, in this
          format, to collect the input of the Web community and prepare the
          work to ultimately follow the W3C standards track should it have the
          necessary support to do so.
        </p>
        <p>
          For the most accurate reflection of the APIs that have been
          implemented by providers see the <a href="./docs/api">API
          documentation</a>.
        </p>
      </div>
    </section>
    <section id="model">
      <h2>
        Model
      </h2>
      <dl>
        <dt>
          <dfn data-lt="monetized">Monetization</dfn>:
        </dt>
        <dd>
          A payment made by a user to a website, facilitated through a
          [=monetization provider=].
        </dd>
        <dt>
          <dfn data-lt="provider">Monetization provider</dfn>:
        </dt>
        <dd>
          The party making payments on behalf of the user. A monetization
          provider leverages the [[[SPSP]]] (<abbr title=
          "Simple Payment Setup Protocol">SPSP</abbr>) together with
          [[[Interledger]]] (<abbr title=
          "Interledger Protocol">ILP</abbr>)/[[[STREAM]]] to provide a
          high-level way to pay a [=monetization receiver=].
        </dd>
        <dt>
          <dfn>Monetization receiver</dfn>:
        </dt>
        <dd>
          The party receiving payments on behalf of the website, whose details
          are provided by a [=payment end-point=].
        </dd>
        <dt>
          <dfn>Payment end-point</dfn>:
        </dt>
        <dd>
          A [=URL=] to a <a data-cite="SPSP#specification">SPSP end-point</a>
          (i.e., a JSON resource containing details that facilitate payment).
        </dd>
      </dl>
    </section>
    <section id="goals" class="informative">
      <h2>
        Goals
      </h2>
      <ul>
        <li>Suitable for static HTML documents, without requiring backend
        infrastructure.
        </li>
        <li>Doesn't require user interaction, but user retains control over
        which sites they monetize and how much they spend.
        </li>
        <li>Developers have a way to associate payments with their users, in
        order to provide a range of experiences.
        </li>
        <li>Pays continuously as the user consumes content.
        </li>
      </ul>
    </section>
    <section>
      <h2>
        Link type "monetization"
      </h2>
      <aside class="issue">
        <p>
          This is a "monkey patch" for the [[HTML]] specification: If accepted,
          this will eventually be moved to HTML itself.
        </p>
      </aside>
      <aside class="note" title="Multiple monetization links">
        <p>
          Although a single HTML document can have multiple [^link^] elements
          with the "monetization" link type, the user agent might restrict the
          number of concurrent [[STREAM]] connections it can simultaneously
          support. In such a case, an "error" event will be fired at the
          [^link^] element where a connection can't be established.
        </p>
      </aside>
      <p>
        The monetization keyword indicates a [=payment end-point=] used to
        monetize the document.
      </p>
      <p>
        The <code data-x="rel-monetization">monetization</code> keyword may be
        used with <code>link</code> elements. This keyword creates an
        <span data-x="external resource link">external resource link</span>.
      </p>
      <p>
        The <code data-x="rel-monetization">monetization</code> keyword
        indicates that some aspect of the document is monetized.
      </p>
      <div>
        <p>
          There is no default type for resources given by the <code data-x=
          "rel-monetization">monetization</code> keyword.
        </p>
        <p>
          The appropriate times to <span data-x=
          "fetch and process the linked resource">fetch and process</span> this
          type of link is:
        </p>
        <ul>
          <li>
            <p>
              When the <span>external resource link</span> is created on a
              <code>link</code> element that is already <span>browsing-context
              connected</span>.
            </p>
          </li><!-- e.g. rel="" changed, href="" set... -->
          <li>
            <p>
              When the <span>external resource link</span>'s <code>link</code>
              element <span>becomes browsing-context connected</span>.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-href">href</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span> is changed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-disabled">disabled</code>
              attribute of the <code>link</code> element of an <span>external
              resource link</span> that is already <span>browsing-context
              connected</span> is set, changed, or removed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-crossorigin">crossorigin</code>
              attribute of the <code>link</code> element of an <span data-x=
              "external resource link">external resource link</span> that is
              already <span>browsing-context connected</span> is set, changed,
              or removed.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-type">type</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span> is set or changed to a value that does not or no
              longer matches the <span data-x="Content-Type">Content-Type
              metadata</span> of the previous obtained external resource, if
              any.
            </p>
          </li>
          <li>
            <p>
              When the <code data-x="attr-link-type">type</code> attribute of
              the <code>link</code> element of an <span>external resource
              link</span> that is already <span>browsing-context
              connected</span>, but was previously not obtained due to the
              <code data-x="attr-link-type">type</code> attribute specifying an
              unsupported type, is set, removed, or changed.
            </p>
          </li>
        </ul>
        <p>
          A user agent MUST NOT <span>delay the load event</span> for this link
          type.
        </p>
        <p>
          The <span>linked resource fetch setup steps</span> for this type of
          linked resource, given a <code>link</code> element <var>element</var>
          and <span data-x="concept-request">request</span> <var>request</var>,
          are:
        </p>
        <ol>
          <li>
            <!-- detached element / non-fully active elements -->
            <p>
              If <var>element</var> <span>cannot navigate</span>, then return
              false.
            </p>
          </li>
          <li>
            <p>
              If <var>element</var>'s <span>node document</span> is not
              [=allowed to use=] the "monetization" feature, return false.
            </p>
          </li>
          <li>
            <p>
              Let <var>context</var> be <var>element</var>'s <span>node
              document</span>'s <span data-x="concept-document-bc">browsing
              context</span>.
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-initiator">initiator</span> to "`document`".
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-destination">destination</span> to
              "<code data-x="">monetization</code>".
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-mode">mode</span> to "<code data-x=
              "">cors</code>".
            </p>
          </li>
          <li>
            <p>
              Set <var>request</var>'s <span data-x=
              "concept-request-credentials-mode">credentials mode</span> to the
              <span>CORS settings attribute credentials mode</span> for
              <var>element</var>'s <code data-x=
              "attr-link-crossorigin">crossorigin</code> content attribute.
            </p>
          </li>
          <li>
            <p>
              Return true.
            </p>
          </li>
        </ol>
        <p>
          To <span data-x="process the linked resource">process this type of
          linked resource</span> given a <code>link</code> element
          <var>element</var>, boolean <var>success</var>, and <span data-x=
          "concept-response">response</span> <var>response</var>:
        </p>
        <ol>
          <li>
            <p>
              If |response|'s status is not an OK status, the set |success| to
              false.
            </p>
          </li>
          <li>
            <p>
              Otherwise, if <var>response</var>'s <span data-x=
              "Content-Type">Content-Type metadata</span> is not a <span>JSON
              MIME type</span>, then set <var>success</var> to false.
            </p>
          </li>
          <li>Let |json| be the result of [=parse JSON bytes to an Infra
          value=] passing |response|'s [=Response/body=].
          </li>
          <li>If |json| is an exception, then set <var>success</var> to false.
          </li>
          <li>If |success| is true, [=perform simple payment validation=] with
          |json| as per [[Interledger]], and set |success| to be the result.
          </li>
          <li>
            <p>
              If the user agent has exhausted the number of allowed [[STREAM]]
              connections, set |success| to false.
            </p>
          </li>
          <li>Otherwise, establish a new [[STREAM]] connection.
          </li>
          <li>[=Queue an element task=] on the [=networking task source=] given
          |element| and the following steps:
            <ol>
              <li>If |success| is true, [=fire an event=] named "load" at
              |element|.
              </li>
              <li>Otherwise, [=fire an event=] named "error" at |element|.
              </li>
            </ol>
          </li>
        </ol>
      </div>
      <p>
        If a "monetization" <code>link</code> <span>becomes browsing-context
        disconnected</span>, a user agent MUST stop monetization [[STREAM]].
      </p>
    </section>
    <section>
      <h2>
        `onmonetization` event handler
      </h2>
      <p>
        The `onmonetization` event handler is an [=event handler content
        attribute=] that can be applied to any [=element=]. The user agent uses
        it to notify that some [^link^] has been [=monetized=].
      </p>
    </section>
    <section id="events">
      <h2>
        monetization event
      </h2>
      <p>
        When the [[[STREAM]]] connection has fulfilled an ILP |packet| with a
        non-zero amount, perform the following steps:
      </p>
      <ol class="algorithm">
        <li>Let |target:HTMLLinkElement| be the {{HTMLLinkElement}} associated
        with the [[[STREAM]]] connection.
        </li>
        <li>If |target| is `null`, then return.
        </li>
        <li>Let |eventInitDict:MonetizationEventInit| be a
        {{MonetizationEventInit}} dictionary, whose members are initialized to
        match |packet|'s details.
        </li>
        <li>Let |event:MonetizationEvent| be a newly constructed
        {{MonetizationEvent}} initialized with |eventInitDict|.
        </li>
        <li>[=Queue a task=] on the [=monetization task source=] to perform the
        following steps:
          <ol>
            <li>If |target| is not connected, return.
            </li>
            <li>[=Fire an event=] named "monetization" at |target|.
            </li>
          </ol>
        </li>
      </ol>
    </section>
    <section data-dfn-for="MonetizationEvent">
      <h2>
        `MonetizationEvent` interface
      </h2>
      <pre class="idl">
        [SecureContext, Exposed=Window]
        interface MonetizationEvent : Event {
          constructor(DOMString type, MonetizationEventInit eventInitDict);
          readonly attribute DOMString amount;
          readonly attribute DOMString assetCode;
          readonly attribute DOMString assetScale;
          readonly attribute DOMString? receipt;
          readonly attribute USVString paymentPointer;
        };

        dictionary MonetizationEventInit : EventInit {
          required DOMString amount;
          required DOMString assetCode;
          required DOMString assetScale;
          required DOMString? receipt;
          required USVString paymentPointer;
        };
      </pre>
      <section>
        <h2>
          <dfn>amount</dfn> attribute
        </h2>
        <p>
          The amount received as by an ILP packet. When getting, returns the
          value it was initialized with.
        </p>
      </section>
      <section>
        <h2>
          <dfn>assetCode</dfn> attribute
        </h2>
        <p>
          The three letter asset code describing the amount's units (e.g.,
          "USD" for US dollars). When getting, returns the value it was
          initialized with.
        </p>
      </section>
      <section>
        <h2>
          <dfn>assetScale</dfn> attribute
        </h2>
        <p>
          The scale of the amount. For example, USD would have an
          <code>assetScale</code> of <code>2</code> when denominated in cents.
          When getting, returns the value it was initialized with.
        </p>
      </section>
      <section>
        <h2>
          <dfn>receipt</dfn> attribute
        </h2>
        <p>
          `null` or a base64-encoded [[[Receipt]]] issued by the [=monetization
          receiver=] to the [=monetization provider=] as proof of the total
          amount received in the stream. When getting, returns the value it was
          initialized with.
        </p>
      </section>
      <section>
        <h2>
          <dfn>paymentPointer</dfn> attribute
        </h2>
        <p>
          A URL representing a [=payment end-point=]. When getting, returns the
          value it was initialized with.
        </p>
      </section>
    </section>
    <section id="relation-to-other-technologies" class="informative">
      <h2>
        Relation to Web Payments
      </h2>
      <p>
        Unlike [[[Payment-Request]]] and the [[[Payment-Handler]]], Web
        Monetization is intended for continuous payments rather than discrete
        payments. Additionally, it is designed to <em>not</em> require any user
        interaction, serving as an alternative to traditional e-commerce
        checkout methods.
      </p>
    </section>
    <section id="conformance" class="appendix"></section>
  </body>
</html>
